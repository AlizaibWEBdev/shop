<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nexlify - Your Cart</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            newlify: {
              primary: '#3B82F6',
              dark: '#2563EB',
              text: '#1F2937',
              light: '#6B7280',
              divider: '#E5E7EB',
              success: '#10B981',
              error: '#EF4444'
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-in-out',
            'slide-up': 'slideUp 0.3s ease-out',
            'pulse-slow': 'pulse 3s infinite'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            }
          }
        }
      }
    };
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .quantity-btn:active {
      transform: scale(0.95);
    }
    .checkout-btn:hover {
      box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3), 0 2px 4px -1px rgba(59, 130, 246, 0.2);
    }
    .empty-cart-illustration {
      opacity: 0.7;
      filter: grayscale(30%);
    }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 antialiased">
  <header class="bg-white shadow-sm py-4 fixed top-0 w-full z-40">
    <div class="container mx-auto px-4 md:px-6 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-newlify-text flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-newlify-primary mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
        </svg>
        Nexlify
      </h1>
      <nav class="flex items-center space-x-4 md:space-x-6">
        <a href="./shop/" class="text-newlify-primary font-medium hover:text-newlify-dark transition-colors hidden sm:inline-flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Back to Shop
        </a>
        <a href="#" onclick="logout()" class="text-newlify-primary hover:text-newlify-dark transition-colors hidden sm:inline-flex items-center">
          <i class="fas fa-sign-out-alt mr-1"></i>
          <span>Logout</span>
        </a>
        <span class="relative inline-block cursor-pointer group">
          <i class="fas fa-shopping-cart text-xl text-newlify-primary group-hover:text-newlify-dark transition-colors"></i>
          <span id="cart_items" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full transform group-hover:scale-110 transition-transform">0</span>
        </span>
        <button class="sm:hidden text-newlify-primary" id="mobile-menu-button">
          <i class="fas fa-bars text-xl"></i>
        </button>
      </nav>
    </div>
    
    <!-- Mobile menu -->
    <div id="mobile-menu" class="hidden bg-white border-t shadow-lg absolute w-full left-0 px-4 py-3">
      <a href="./shop/" class="block py-2 text-newlify-primary hover:text-newlify-dark transition-colors">
        <i class="fas fa-arrow-left mr-2"></i> Back to Shop
      </a>
      <a href="#" onclick="logout()" class="block py-2 text-newlify-primary hover:text-newlify-dark transition-colors">
        <i class="fas fa-sign-out-alt mr-2"></i> Logout
      </a>
    </div>
  </header>

  <main class="container mx-auto px-4 md:px-6 pt-24 pb-12">
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-3xl font-bold text-newlify-text">Your Shopping Cart</h2>
      <div id="loading-indicator" class="hidden flex items-center text-newlify-primary">
        <svg class="animate-spin -ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Updating...
      </div>
    </div>
    
    <div id="cart-container" class="space-y-4 md:space-y-6"></div>

    <div id="summary" class="mt-8 bg-white rounded-xl shadow-md p-6 w-full hidden animate-fade-in">
      <h3 class="font-bold text-xl mb-6 text-newlify-text">Order Summary</h3>
      <div class="space-y-4 mb-6" id="summary-details"></div>
      <button onclick="proceedToCheckout()" class="w-full bg-gradient-to-r from-newlify-primary to-newlify-dark text-white py-3 px-5 rounded-lg font-semibold hover:opacity-90 transition-opacity checkout-btn flex items-center justify-center">
        <span>Proceed to Checkout</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
        </svg>
      </button>
    </div>
  </main>

  <script>
    // Mobile menu toggle
    document.getElementById('mobile-menu-button').addEventListener('click', function() {
      const menu = document.getElementById('mobile-menu');
      menu.classList.toggle('hidden');
    });

    // Check for authentication
    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "../login.html";
    }

    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || !user.id) {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "../login.html";
    }

    const userId = user.id;
    const cartContainer = document.getElementById("cart-container");
    const summary = document.getElementById("summary");
    const summaryDetails = document.getElementById("summary-details");
    const cartItemsCount = document.getElementById("cart_items");
    const loadingIndicator = document.getElementById("loading-indicator");

    async function updateCartItemCount() {
      try {
        const response = await fetch(`https://fitsedit.tooliso.com/cart/count?user_id=${userId}`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        const data = await response.json();
        if (response.ok) {
          cartItemsCount.textContent = data.count || 0;
        } else {
          console.error("Failed to fetch cart count:", data.message);
          cartItemsCount.textContent = "0";
        }
      } catch (error) {
        console.error("Error fetching cart count:", error);
        cartItemsCount.textContent = "0";
      }
    }

    async function fetchCartAndRender() {
      try {
        loadingIndicator.classList.remove('hidden');
        
        const response = await fetch(`https://fitsedit.tooliso.com/cart/getdata?user_id=${userId}`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            window.location.href = "../login.html";
            return;
          }
          throw new Error("Failed to fetch cart data");
        }

        const cartItems = await response.json();
        cartContainer.innerHTML = "";

        if (cartItems.length === 0) {
          cartContainer.innerHTML = `
            <div class="text-center py-12 animate-fade-in">
              <div class="empty-cart-illustration max-w-md mx-auto mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-40 w-40 mx-auto text-newlify-light" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
              </div>
              <h3 class="text-xl font-medium text-newlify-text mb-2">Your cart is empty</h3>
              <p class="text-newlify-light mb-6">Looks like you haven't added anything to your cart yet</p>
              <a href="./shop/" class="inline-block bg-newlify-primary text-white py-2 px-6 rounded-lg font-medium hover:bg-newlify-dark transition-colors">
                Start Shopping
              </a>
            </div>
          `;
          summary.classList.add("hidden");
          updateCartItemCount();
          loadingIndicator.classList.add('hidden');
          return;
        }

        let total = 0;
        let totalItems = 0;

        cartItems.forEach(item => {
          const itemTotal = item.price * item.quantity;
          total += itemTotal;
          totalItems += item.quantity;

          const productCard = `
            <div id="item-${item._id}" class="card bg-white rounded-xl shadow-sm overflow-hidden flex flex-col md:flex-row transition-all duration-300 card-hover border border-gray-100 animate-slide-up">
              <div class="md:w-1/3 h-48 bg-gray-100 flex items-center justify-center p-4">
                <img src="${item.imageUrl}" alt="${item.title}" class="object-contain h-full w-full">
              </div>
              <div class="p-6 md:w-2/3 flex flex-col justify-between">
                <div>
                  <div class="flex justify-between items-start">
                    <h3 class="font-semibold text-lg mb-2 text-newlify-text">${item.title}</h3>
                    <button onclick="removeItem('${item._id}')" class="text-newlify-light hover:text-newlify-error transition-colors">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                  <p class="text-newlify-light mb-4">$${item.price.toFixed(2)} each</p>
                </div>
                <div class="flex items-center justify-between">
                  <span class="font-bold text-newlify-text text-xl">$<span id="price-${item._id}">${itemTotal.toFixed(2)}</span></span>
                  <div class="flex items-center border rounded-lg overflow-hidden">
                    <button onclick="updateQuantity('${item._id}', 'decrease')" class="px-4 py-2 text-newlify-primary hover:bg-gray-100 quantity-btn transition-colors">
                      <i class="fas fa-minus"></i>
                    </button>
                    <span class="px-4 text-center min-w-[40px]" id="qty-btn-${item._id}">${item.quantity}</span>
                    <button onclick="updateQuantity('${item._id}', 'increase')" class="px-4 py-2 text-newlify-primary hover:bg-gray-100 quantity-btn transition-colors">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
          cartContainer.insertAdjacentHTML('beforeend', productCard);
        });

        const summaryHtml = `
          <div class="flex justify-between py-2">
            <span class="text-newlify-light">Subtotal (${totalItems} ${totalItems === 1 ? 'item' : 'items'})</span>
            <span class="font-medium">$${total.toFixed(2)}</span>
          </div>
          <div class="flex justify-between py-2 border-b border-newlify-divider">
            <span class="text-newlify-light">Shipping</span>
            <span class="text-newlify-success font-medium">Free</span>
          </div>
          <div class="flex justify-between font-bold text-newlify-text text-lg pt-4">
            <span>Total</span>
            <span>$${total.toFixed(2)}</span>
          </div>
        `;
        summaryDetails.innerHTML = summaryHtml;
        summary.classList.remove("hidden");
        updateCartItemCount();
        loadingIndicator.classList.add('hidden');
      } catch (error) {
        console.error("Error fetching cart:", error);
        cartContainer.innerHTML = `
          <div class="bg-newlify-error bg-opacity-10 border-l-4 border-newlify-error p-4 text-newlify-error animate-pulse-slow">
            <div class="flex items-center">
              <i class="fas fa-exclamation-circle mr-2"></i>
              <strong>Error:</strong> Failed to load cart. Please try again later.
            </div>
            <button onclick="fetchCartAndRender()" class="mt-2 text-sm text-newlify-primary hover:underline">
              <i class="fas fa-sync-alt mr-1"></i> Retry
            </button>
          </div>
        `;
        summary.classList.add("hidden");
        updateCartItemCount();
        loadingIndicator.classList.add('hidden');
      }
    }

    async function updateQuantity(itemId, action) {
      try {
        loadingIndicator.classList.remove('hidden');
        
        const response = await fetch(`https://fitsedit.tooliso.com/cart/${action}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({
            user_id: userId,
            item_id: itemId
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          if (data.removed) {
            document.getElementById(`item-${itemId}`).classList.add('opacity-0', 'translate-x-10', 'transition-all', 'duration-300');
            setTimeout(() => {
              document.getElementById(`item-${itemId}`).remove();
              fetchCartAndRender(); // Refresh totals and cart count
            }, 300);
          } else {
            const newQty = data.quantity;
            const pricePerItem = parseFloat(document.getElementById(`price-${itemId}`).textContent) / parseInt(document.getElementById(`qty-btn-${itemId}`).textContent);
            document.getElementById(`qty-btn-${itemId}`).textContent = newQty;
            document.getElementById(`price-${itemId}`).textContent = (pricePerItem * newQty).toFixed(2);
            fetchCartAndRender(); // Refresh totals and cart count
          }
        } else {
          showToast(data.message || "Failed to update quantity.", 'error');
        }
      } catch (err) {
        console.error("Quantity update failed:", err);
        showToast("Failed to update quantity. Please try again.", 'error');
      } finally {
        loadingIndicator.classList.add('hidden');
      }
    }

    async function removeItem(itemId) {
      try {
        if (confirm("Are you sure you want to remove this item from your cart?")) {
          loadingIndicator.classList.remove('hidden');
          
          const response = await fetch(`https://fitsedit.tooliso.com/cart/remove`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({
              user_id: userId,
              item_id: itemId
            })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            document.getElementById(`item-${itemId}`).classList.add('opacity-0', 'translate-x-10', 'transition-all', 'duration-300');
            setTimeout(() => {
              document.getElementById(`item-${itemId}`).remove();
              fetchCartAndRender(); // Refresh totals and cart count
            }, 300);
            showToast("Item removed from cart", 'success');
          } else {
            showToast(data.message || "Failed to remove item.", 'error');
          }
        }
      } catch (err) {
        console.error("Remove item failed:", err);
        showToast("Failed to remove item. Please try again.", 'error');
      } finally {
        loadingIndicator.classList.add('hidden');
      }
    }

    function proceedToCheckout() {
      // Create checkout modal with address input
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-xl max-w-md w-full p-6 animate-fade-in">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-newlify-text">Enter Shipping Address</h3>
            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-newlify-light hover:text-newlify-text">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <form id="checkout-form" class="space-y-4">
            <div>
              <label for="address" class="block text-sm font-medium text-newlify-text">Shipping Address</label>
              <textarea id="address" name="address" rows="4" class="mt-1 block w-full px-3 py-2 border border-newlify-divider rounded-md shadow-sm focus:outline-none focus:ring-newlify-primary focus:border-newlify-primary" placeholder="Enter your full shipping address" required></textarea>
            </div>
            <div id="checkout-error" class="hidden text-newlify-error text-sm"></div>
            <div class="flex justify-end space-x-3">
              <button type="button" onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" class="px-4 py-2 text-newlify-primary hover:bg-gray-100 rounded-lg transition-colors">
                Cancel
              </button>
              <button type="submit" id="checkout-submit" class="px-4 py-2 bg-newlify-primary text-white rounded-lg hover:bg-newlify-dark transition-colors flex items-center">
                <span>Place Order</span>
                <svg id="checkout-loading" class="hidden animate-spin ml-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      // Handle form submission
      const form = document.getElementById('checkout-form');
      const submitButton = document.getElementById('checkout-submit');
      const loadingSpinner = document.getElementById('checkout-loading');
      const errorDiv = document.getElementById('checkout-error');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const address = document.getElementById('address').value.trim();

        if (!address) {
          errorDiv.textContent = 'Please provide a shipping address.';
          errorDiv.classList.remove('hidden');
          return;
        }

        try {
          submitButton.disabled = true;
          loadingSpinner.classList.remove('hidden');
          errorDiv.classList.add('hidden');

          const response = await fetch('https://fitsedit.tooliso.com/checkout', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              user_id: userId,
              address
            })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            modal.remove();
            // Show success modal with order details
            const successModal = document.createElement('div');
            successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            successModal.innerHTML = `
              <div class="bg-white rounded-xl max-w-md w-full p-6 animate-fade-in">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-bold text-newlify-text">Order Placed Successfully</h3>
                  <button onclick="this.parentElement.parentElement.parentElement.remove(); fetchCartAndRender();" class="text-newlify-light hover:text-newlify-text">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <div class="space-y-4">
                  <p class="text-newlify-text"><strong>Tracking ID:</strong> ${data.order.trackingId}</p>
                  <p class="text-newlify-text"><strong>Total:</strong> $${data.order.totalAmount.toFixed(2)}</p>
                  <p class="text-newlify-text"><strong>Order Date:</strong> ${new Date().toLocaleDateString()}</p>
                  <p class="text-newlify-text"><strong>Status:</strong> ${data.order.status}</p>
                  <p class="text-newlify-light">Your order has been placed and will be processed soon. You can track it using the tracking ID.</p>
                </div>
                <div class="flex justify-end mt-6">
                  <button onclick="this.parentElement.parentElement.parentElement.remove(); fetchCartAndRender();" class="px-4 py-2 bg-newlify-primary text-white rounded-lg hover:bg-newlify-dark transition-colors">
                    Continue Shopping
                  </button>
                </div>
              </div>
            `;
            document.body.appendChild(successModal);
            showToast('Order placed successfully!', 'success');
          } else {
            errorDiv.textContent = data.message || 'Failed to place order. Please try again.';
            errorDiv.classList.remove('hidden');
          }
        } catch (err) {
          console.error('Checkout failed:', err);
          errorDiv.textContent = 'Failed to place order. Please try again.';
          errorDiv.classList.remove('hidden');
        } finally {
          submitButton.disabled = false;
          loadingSpinner.classList.add('hidden');
        }
      });
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-medium flex items-center ${
        type === 'success' ? 'bg-newlify-success' : 'bg-newlify-error'
      } animate-fade-in`;
      toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
        ${message}
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.remove('animate-fade-in');
        toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '../login.html';
    }

    // Initial render
    document.addEventListener('DOMContentLoaded', () => {
      fetchCartAndRender();
      
      // Add animation to empty cart if it appears
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.addedNodes.length) {
            mutation.addedNodes.forEach(node => {
              if (node.id && node.id.startsWith('item-')) {
                node.classList.add('animate-slide-up');
              }
            });
          }
        });
      });
      
      observer.observe(cartContainer, { childList: true });
    });
  </script>
</body>
</html>